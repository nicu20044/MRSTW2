@using MusicStore2.Domain.Entities.Product
@model IEnumerable<ProductData>

@{
    ViewData["Title"] = "Home Page";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="hero-section">
    <img src="~/UploadedImages/header_image.jpg" alt="header_image">
</div>

<div class="container">
    <section class="tracks-section">
        <div class="section-header">
            <h2>Popular Tracks</h2>
            <a href="/popular"></a>
        </div>
        <div class="tracks-grid">
            @foreach (var product in Model.Take(5))
            {
                <a href="@Url.Action("Details", "Product", new { id = product.Id })" class="track-card-link">
                    <div class="track-card">
                        <div class="track-image">
                            <img src="@Url.Content(product.ImageUrl)" alt="Track artwork" />
                            <button class="play-button play-toggle" data-audio-id="audio-@product.Id" onclick="event.preventDefault(); togglePlay(this)">
                                <svg viewBox="0 0 24 24" width="24" height="24">
                                    <path d="M8 5v14l11-7z" fill="currentColor" />
                                </svg>
                            </button>
                            <audio id="audio-@product.Id" src="@Url.Content(product.AudioFileUrl)"></audio>
                        </div>
                        <div class="track-info">
                            <h3>@product.Name</h3>
                            <p>@product.ArtistName</p>
                        </div>
                    </div>
                </a>
            }

        </div>
    </section>

    <section class="tracks-section">
        <div class="section-header">
            <h2>New Releases</h2>
            <a href="/new"></a>
        </div>
        <div class="tracks-grid">
            @foreach (var product in Model.OrderByDescending(p => p.UploadDate).Take(5))
            {
                <a href="@Url.Action("Details", "Product", new { id = product.Id })" class="track-card-link">
                    <div class="track-card">
                        <div class="track-image">
                            <img src="@Url.Content(product.ImageUrl)" alt="Track artwork" />
                            <button class="play-button play-toggle" data-audio-id="audio-@product.Id" onclick="event.preventDefault(); togglePlay(this)">
                                <svg viewBox="0 0 24 24" width="24" height="24">
                                    <path d="M8 5v14l11-7z" fill="currentColor" />
                                </svg>
                            </button>
                            <audio id="audio-@product.Id" src="@Url.Content(product.AudioFileUrl)"></audio>
                        </div>
                        <div class="track-info">
                            <h3>@product.Name</h3>
                            <p>@product.ArtistName</p>
                        </div>
                    </div>
                </a>
            }

        </div>
    </section>
</div>

<script>
    const allAudioElements = document.querySelectorAll("audio");

    function togglePlay(button) {
        const audioId = button.getAttribute("data-audio-id");
        const audio = document.getElementById(audioId);

        allAudioElements.forEach(a => {
            if (a !== audio) {
                a.pause();
                a.currentTime = 0;
                updateButtonIcon(a.id, false);
            }
        });

        if (audio.paused) {
            audio.play();
            updateButtonIcon(audioId, true);
        } else {
            audio.pause();
            updateButtonIcon(audioId, false);
        }
    }

    function updateButtonIcon(audioId, isPlaying) {
        const button = document.querySelector(`.play-toggle[data-audio-id="${audioId}"]`);
        const svg = button.querySelector("svg");

        if (isPlaying) {
            svg.innerHTML = `<path d="M6 4h4v16H6zm8 0h4v16h-4z" fill="currentColor"/>`;
        } else {
            svg.innerHTML = `<path d="M8 5v14l11-7z" fill="currentColor"/>`;
        }
    }
</script>
